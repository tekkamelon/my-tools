#!/bin/sh 

set -eu

# shellcheck disable=SC1112

# 全角文字から半角文字への変換関数
convert_to_halfwidth() {
    sed 'y/ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ０１２３４５６７８９/ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789/; y/　／（）’"！？/ \/\(\)'\''"\!\?/'
}

# 標準入力からの処理
if [ -p /dev/stdin ]; then

	convert_to_halfwidth

# 引数からの処理
elif [ "${#}" -gt 0 ]; then

file="${1}"

	# ファイル存在確認
	if [ ! -f "${file}" ]; then
		echo "Error: File '${file}' not found." >&2
		exit 1
	fi

	# ファイルが書き込み可能か確認
	if [ ! -w "${file}" ]; then
		echo "Error: File '${file}' is not writable." >&2
		exit 1
	fi

	# 全角文字から半角文字への変換,一時ファイルに保存
	cat "${file}" | convert_to_halfwidth > "${file}.tmp" &&
	
	# 一時ファイルを元のファイルに上書き
	mv "${file}.tmp" "${file}"

else

	# 引数なしの場合はエラーメッセージを出力
	cat <<- EOF >&2
	Error: Please provide either stdin input or a file argument.
	Usage: echo '全角文字' | z2h
           z2h filename
	EOF
	
	exit 1

fi

