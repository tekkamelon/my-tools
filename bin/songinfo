#!/bin/sh

set -eu

# MPD設定ファイルからmusic_directoryを取得
get_music_dir(){

    if [ -e "${HOME}/.config/mpd/mpd.conf" ]; then

        grep ^music_directory "${HOME}/.config/mpd/mpd.conf" | cut -d'"' -f2

    elif [ -e "${HOME}/.mpdconf" ]; then

        grep ^music_directory "${HOME}/.mpdconf" | cut -d'"' -f2

    elif [ -e "/etc/mpd.conf" ]; then

        grep ^music_directory "/etc/mpd.conf" | cut -d'"' -f2

    else

        echo ""

    fi

}

music_dir=$(get_music_dir)

# music_directoryが見つからない場合のエラー処理
if [ -z "${music_dir}" ]; then

	# エラーメッセージを通知
    notify-send "Error: mpd.conf not found or music_directory not set" &
    echo "Error: mpd.conf not found or music_directory not set" >&2

    exit 1

fi

# 再生中の曲の相対パスを抽出
current_song=$(mpc current -f "%file%" 2>/dev/null)

# current_songが空の場合のエラー処理
if [ -z "${current_song}" ]; then

    notify-send "Error: No song is currently playing" &
    echo "Error: No song is currently playing" >&2

    exit 1

fi

# ディレクトリのみ抽出
song_path="${current_song%/*}"

# カバーアートまでの絶対パス
img_dir="${music_dir}/${song_path}/Folder.jpg"

# カバーアートファイルの存在確認
if [ ! -f "$img_dir" ]; then

    img_dir=""

fi

notify-send "$(mpc status)" -i "${img_dir}" &

