#!/bin/sh -eu

# 名前付きパイプを作成
mkfifo /tmp/pre.fifo /tmp/post.fifo

# 現在のディレクトリ
current_dir=$(pwd)

# 引数で指定されたディレクトリ
working_dir="${*}"

# リッピング前のディレクトリ構造を名前付きパイプに流す
ls "${working_dir}" > /tmp/pre.fifo &

#引数があれば真
if [ -n "${working_dir}" ] ; then

	cd "${working_dir}"

	# 非対話的に処理
	abcde -N 

	# リッピング後のディレクトリ構造を名前付きパイプに流す
	ls > /tmp/post.fifo &
	
	diff_dir=$(diff -c /tmp/pre.fifo /tmp/post.fifo |

	awk '/^\+ /{

		sub("\+ " , "")

		print $0

	}')

	find "${diff_dir}" | awk 'NR ==1' | xargs -I{} ffmpeg -i "${diff_dir}"/{} 2>&1 |
	
	grep ARTIST | awk -F": " '{print $2}' | xargs mkdir

else

	# エラーメッセージを出力
	echo "Error: please enter args" > /dev/stderr

fi

cd "${current_dir}"

rm /tmp/pre.fifo /tmp/post.fifo &
