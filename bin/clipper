#!/bin/sh 

set -eu

# shellcheck disable=SC1091

# ロケールの設定
export LC_ALL=C
export LANG=C

# 設定ファイルの読み込み
if [ -e "${HOME}/.abcde.conf" ]; then

	# 設定ファイルの変数を読み込み
	. "${HOME}/.abcde.conf"

elif [ -e "/etc/abcde.conf" ]; then

	# 設定ファイルの変数を読み込み
	. /etc/abcde.conf

else

    # 設定ファイルが存在しない場合、初期値を設定
	export ALBUMARTFILE="Folder.jpg"
	# 現在のディレクトリ
	export OUTPUTDIR="${PWD}"

fi

# 実行時点のディレクトリを保存
pre_dir="${PWD}"

# 第一引数が指定されていればそのディレクトリに移動し、なければOUTPUTDIRへ移動
if [ "${#}" -ge 1 ]; then

    cd "${1}"

else

	cd "${OUTPUTDIR}"

fi

# カバーアートのディレクトリ名
coverart="albumart_backup"

# CDDBから取得したデータをキャプチャ
acquired_data=$(abcde -a cddb -N 2>&1)

# CDDBデータ取得結果のエラーチェック

if echo "${acquired_data}" | grep -q 'error "Not Found"'; then

    echo "Error: CD data is not found for CDDB!" >&2
    exit 1

fi

# 非対話的に処理：カバーアートを取得、ファイルに埋め込み、中間ファイルを生成しない
abcde -N -G -B -P -p -a cddb,encode,tag,move,clean

# カバーアートのディレクトリを検索（-dオプションの代わりに-type dを使用）
coverart_dir=$(find "${PWD}" -type d -name "${coverart}" 2> /dev/null)

# カバーアートディレクトリが存在すればその中に移動し、ファイルを上位ディレクトリへ移動
if [ -n "${coverart_dir}" ]; then

	cd "${coverart_dir}"
    mv "${ALBUMARTFILE}" ..
    cd ..
    rmdir "${coverart}" || true
	cd "${pre_dir}"

else

    echo "カバーアートのディレクトリが見つかりませんでした" >&2

fi

eject

