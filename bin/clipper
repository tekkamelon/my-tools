#!/bin/sh 

# shellcheck disable=SC1091

set -eu

export LC_ALL=C
export LANG=C

# 現在のディレクトリ
pre_dir="${PWD}"

# カバーアートのディレクトリ名
coverart="albumart_backup"

# ホームディレクトリに設定ファイルがあれば真
if [ -e "${HOME}/.abcde.conf" ]; then

	# 設定ファイルの変数を読み込み
	. "${HOME}/.abcde.conf"

# /etc以下に設定ファイルがあれば真
elif [ -e "/etc/abcde.conf" ]; then

	. /etc/abcde.conf

else

    # 設定ファイルが存在しない場合、初期値を設定
	export ALBUMARTFILE="Folder.jpg"
	# 現在のディレクトリ
	export OUTPUTDIR="${PWD}"

fi

# 第一引数が指定されていればそのディレクトリに移動,なければOUTPUTDIRへ移動
cd "${1:-$OUTPUTDIR}"

# CDDBからデータを取得
acquired_data="$(abcde -a cddb -N 2>&1)"

# CDDBからデータを取得できなければ真
if echo "${acquired_data}" | grep -q 'error "Not Found"'; then

	# エラーメッセージを出力
    echo "Error: CD data is not found for CDDB!" >&2
    exit 1

fi

# 非対話的に処理:取得したカバーアートをファイルに埋め込み,中間ファイルを生成しない
abcde -N -G -B -P -p -a cddb,encode,tag,move,clean

# カバーアートのディレクトリを検索
coverart_dir=$(find "${PWD}" -type d -name "${coverart}")

# カバーアートのディレクトリが存在すれば真
if [ -n "${coverart_dir}" ]; then

	# カバーアートをカレントディレクトリに移動
    mv "${coverart_dir}/${ALBUMARTFILE}" .
    rmdir "${coverart_dir}" || true

fi

# 現在のディレクトリを元に戻す
cd "${pre_dir}"

eject

