#!/bin/sh

set -eu

# gemini,qwenどちらもなければメッセージを表示
# geminiとqwenの存在確認とメニュー作成
available_tools=""

if command -v gemini > /dev/null 2>&1; then

    available_tools="${available_tools}\ngemini"

fi

if command -v qwen > /dev/null 2>&1; then

    available_tools="${available_tools}\nqwen"

fi

if [ -z "${available_tools}" ]; then

    cat <<- EOS >&2
		Neither gemini nor qwen is installed or not in PATH.
		Please install one of them:
		For gemini: npx https://github.com/google-gemini/gemini-cli or npm install -g @google/gemini-cli
		For qwen: npm install -g @qwen-code/qwen-code
	EOS

    exit 1

fi

# AIツール選択メニュー
ai_tool=$(echo "${available_tools}" | fzf --layout=reverse --prompt="AIツールを選択 > ")

if [ -z "${ai_tool}" ]; then

    exit 1

fi

# メニュー項目の定義
menu_items=$(cat <<- EOS
1:git commitの作成
2:git commitの打ち消し
3:READMEへの反映
4:READMEを添削
EOS
)

# 選択処理
selected=$(echo "${menu_items}" | fzf --layout=reverse --prompt="操作を選択 > " | cut -d":" -f1)

# 選択処理で受け取った変数に応じプロンプトを変数に代入
case "${selected}" in

    1)
        message="gitから変更点を確認し適切なコミットを作成してください.コミットの作成時に許可を得る必要はありません"
        ;;
	2)
		message="現在のgit commitをgit revertで打ち消してください.操作時に許可は不要です"
		;;
    3)
        message="gitの履歴を確認し必要であれば@README.mdに追記してください"
        ;;
    4)
        message="@README.mdの内容を添削し変更点を別ファイルに書き出してください"
        ;;
    *)
        exit 1
        ;;

esac

# 選択されたAIツールで実行
case "${ai_tool}" in

    gemini)
        gemini --yolo -p "${message}"
        ;;

    qwen)
        qwen --yolo -p "${message}"
        ;;

esac
